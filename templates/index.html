<!-- qr_location_tracker/templates/index.html -->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>샘플 정보</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 600px; margin: auto; }
        .container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
        h1 { color: #333; }
        p { margin: 10px 0; }
        strong { min-width: 120px; display: inline-block; }
        #status { margin-top: 20px; font-style: italic; color: #555; }
    </style>
    <!-- 카카오맵 API 로드 -->
    <!-- API 키를 서버에서 전달받은 변수 {{ kakao_app_key }} 로 동적 로드합니다. -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_app_key }}&libraries=services"></script>
</head>
<body>
    <div class="container">
        <h1>샘플 정보</h1>
        <p><strong>샘플 제작일:</strong> {{ data['제작일'] }}</p>
        <p><strong>샘플 제작 사양:</strong> {{ data['제작 사양'] }}</p>
        <p><strong>기본 성능:</strong> {{ data['기본 성능'] }}</p>
        <p><strong>기타:</strong> {{ data['기타'] }}</p>
        <hr>
        <p><strong>마지막 확인 위치:</strong> <span id="location-display">{{ location.address }}</span></p>

        <p id="status">현재 위치를 확인하는 중입니다...</p>
    </div>

    <script>
        // 페이지 로드 시 위치 정보 가져오기 실행
        window.onload = function() {
            // kakao_app_key가 제대로 전달되지 않았을 경우를 대비한 방어 코드
            const kakaoAppKey = "{{ kakao_app_key }}";
            if (!kakaoAppKey) {
                document.getElementById('status').textContent = "오류: 카카오 API 키가 설정되지 않았습니다. 관리자에게 문의하세요.";
                console.error("Kakao App Key is missing.");
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onSuccess, onError, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                document.getElementById('status').textContent = "이 브라우저는 위치 정보를 지원하지 않습니다.";
            }
        };

        // 위치 정보 가져오기 성공 시
        function onSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            document.getElementById('status').textContent = "위치 확인 완료! 서버에 기록 중...";
            
            // 카카오 API로 좌표를 주소로 변환
            const geocoder = new kakao.maps.services.Geocoder();
            const coord = new kakao.maps.LatLng(lat, lon);
            
            geocoder.coord2Address(coord.getLng(), coord.getLat(), function(result, status) {
                let address = "주소 변환 실패";
                if (status === kakao.maps.services.Status.OK && result.length > 0) {
                    // 도로명 주소가 있으면 사용, 없으면 지번 주소 사용
                    address = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                }
                
                // 서버에 위치 정보 전송
                sendLocationToServer(lat, lon, address);
            });
        }

        // 위치 정보 가져오기 실패 시
        function onError(error) {
            let message = "";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "위치 정보 접근 권한이 거부되었습니다.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "현재 위치를 확인할 수 없습니다.";
                    break;
                case error.TIMEOUT:
                    message = "위치 정보를 가져오는 데 시간이 초과되었습니다.";
                    break;
                default:
                    message = "알 수 없는 오류가 발생했습니다.";
                    break;
            }
            document.getElementById('status').textContent = "오류: " + message;
        }

        // 서버로 위치 정보를 POST 요청으로 보냄
        async function sendLocationToServer(lat, lon, address) {
            try {
                const response = await fetch('/update_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ lat, lon, address })
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    document.getElementById('status').textContent = "현재 위치가 서버에 성공적으로 기록되었습니다.";
                    // 페이지를 새로고침하지 않고도 화면의 위치를 즉시 업데이트
                    document.getElementById('location-display').textContent = address;
                } else {
                    throw new Error(result.message || 'Unknown server error');
                }
            } catch (err) {
                console.error("서버 업데이트 실패:", err);
                document.getElementById('status').textContent = "서버에 위치를 기록하는 데 실패했습니다.";
            }
        }
    </script>
</body>
</html>
