<!-- index.html 파일의 <script> 태그 부분을 아래 코드로 교체하세요. -->

<script>
    // 1. 카카오맵 API 스크립트를 동적으로 생성하고, 로드 완료 시 실행될 함수를 지정합니다.
    function loadKakaoMapScript() {
        const script = document.createElement('script');
        // 로드가 완료되면 initMap 함수를 실행하도록 콜백을 추가합니다.
        script.onload = () => kakao.maps.load(initMap);
        script.src = "//dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_app_key }}&libraries=services&autoload=false"; // autoload=false가 중요
        document.head.appendChild(script);
    }

    // 2. 위치 정보를 요청하고 처리하는 핵심 로직
    function initMap() {
        console.log("Kakao Map API is loaded. Now getting geolocation.");
        document.getElementById('status').textContent = "현재 위치를 확인하는 중입니다...";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            document.getElementById('status').textContent = "이 브라우저는 위치 정보를 지원하지 않습니다.";
        }
    }

    // 3. 위치 정보 가져오기 성공 시 (이 함수는 이제 kakao 객체가 보장된 상태에서 호출됨)
    function onSuccess(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        console.log(`Geolocation success: lat=${lat}, lon=${lon}`);
        document.getElementById('status').textContent = "위치 확인 완료! 서버에 기록 중...";
        
        const geocoder = new kakao.maps.services.Geocoder();
        const coord = new kakao.maps.LatLng(lat, lon);
        
        geocoder.coord2Address(coord.getLng(), coord.getLat(), function(result, status) {
            let address = "주소 변환 실패";
            if (status === kakao.maps.services.Status.OK && result.length > 0) {
                address = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;
                console.log(`Address converted: ${address}`);
            } else {
                console.error("Address conversion failed. Status:", status);
            }
            
            sendLocationToServer(lat, lon, address);
        });
    }

    // 4. 위치 정보 가져오기 실패 시
    function onError(error) {
        let message = "";
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = "위치 정보 접근 권한이 거부되었습니다.";
                break;
            case error.POSITION_UNAVAILABLE:
                message = "현재 위치를 확인할 수 없습니다.";
                break;
            case error.TIMEOUT:
                message = "위치 정보를 가져오는 데 시간이 초과되었습니다.";
                break;
            default:
                message = "알 수 없는 오류가 발생했습니다.";
                break;
        }
        console.error("Geolocation error:", message);
        document.getElementById('status').textContent = "오류: " + message;
    }

    // 5. 서버로 위치 정보를 POST 요청으로 보냄
    async function sendLocationToServer(lat, lon, address) {
        console.log(`Sending to server: lat=${lat}, lon=${lon}, address=${address}`);
        try {
            const response = await fetch('/update_location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat, lon, address })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                console.log("Server update successful:", result.location);
                document.getElementById('status').textContent = "현재 위치가 서버에 성공적으로 기록되었습니다.";
                document.getElementById('location-display').textContent = address;
            } else {
                throw new Error(result.message || 'Unknown server error');
            }
        } catch (err) {
            console.error("Failed to send location to server:", err);
            document.getElementById('status').textContent = "서버에 위치를 기록하는 데 실패했습니다.";
        }
    }

    // 페이지가 로드되면 스크립트 로딩을 시작합니다.
    window.onload = function() {
        const kakaoAppKey = "{{ kakao_app_key }}";
        if (!kakaoAppKey) {
            document.getElementById('status').textContent = "오류: 카카오 API 키가 설정되지 않았습니다.";
            console.error("Kakao App Key is missing.");
            return;
        }
        loadKakaoMapScript();
    };
</script>
